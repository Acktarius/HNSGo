<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HNS Go Browser</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>üåê HNSGo Browser</h1>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search or enter website">
        </div>
        
        <div class="shortcuts" id="shortcuts">
            <div class="shortcut" id="favoritesSelector" onclick="showFavoritesMenu()">
                <div class="shortcut-icon">‚≠ê</div>
                <div class="shortcut-name">Favorites</div>
            </div>
            <div class="shortcut" id="searchEngineSelector" onclick="showSearchEngineMenu()">
                <div class="shortcut-icon" id="searchEngineIcon">ü¶Ü</div>
                <div class="shortcut-name" id="searchEngineName">DuckDuckGo</div>
            </div>
            <a href="https://handshake.org/" class="shortcut">
                <div class="shortcut-icon">                    
                    <img src="icons/logo-handshake.png" alt="Handshake" class="shortcut-icon-img">
                </div>
                <div class="shortcut-name">Handshake</div>
            </a>
            <div class="shortcut" id="cleanSelector" onclick="clearCookiesAndHistory()">
                <div class="shortcut-icon">üßπ</div>
                <div class="shortcut-name">Clean</div>
            </div>
            <a href="https://namebase.io/" class="shortcut">
                <div class="shortcut-icon">
                    <img src="icons/favicon-namebase.png" alt="Namebase" class="shortcut-icon-img">
                </div>
                <div class="shortcut-name">Namebase</div>
            </a>
            <a href="https://website.conceal/" class="shortcut">
                <div class="shortcut-icon">
                    <img src="icons/logo-conceal.svg" alt="Conceal Network" class="shortcut-icon-img shortcut-icon-conceal">
                </div>
                <div class="shortcut-name">Conceal Network</div>    
            </a>
        </div>
        
        <div class="recent-tabs">
            <div class="section-title">Recent History</div>
            <div id="recentTabsList"></div>
        </div>
    </div>
    
    <!-- Favorites Menu -->
    <div class="search-engine-menu" id="favoritesMenu" onclick="hideFavoritesMenu(event)">
        <div class="search-engine-options" onclick="event.stopPropagation()">
            <h2 style="margin-bottom: 20px; text-align: center;">Favorites</h2>
            <div id="favoritesList">
                <p style="text-align: center; color: #666; padding: 20px;">Loading favorites...</p>
            </div>
        </div>
    </div>
    
    <!-- Custom Dialog -->
    <div class="custom-dialog-overlay" id="customDialogOverlay" onclick="hideCustomDialog()">
        <div class="custom-dialog" onclick="event.stopPropagation()">
            <div class="custom-dialog-title" id="customDialogTitle">HNSGo</div>
            <div class="custom-dialog-message" id="customDialogMessage"></div>
            <div class="custom-dialog-buttons" id="customDialogButtons"></div>
        </div>
    </div>
    
    <!-- Search Engine Selector Menu -->
    <div class="search-engine-menu" id="searchEngineMenu" onclick="hideSearchEngineMenu(event)">
        <div class="search-engine-options" onclick="event.stopPropagation()">
            <h2 style="margin-bottom: 20px; text-align: center;">Select Search Engine</h2>
            <div class="search-engine-option" data-engine="duckduckgo" onclick="selectSearchEngine('duckduckgo', 'ü¶Ü', 'DuckDuckGo')">
                <div class="search-engine-option-icon">ü¶Ü</div>
                <div class="search-engine-option-name">DuckDuckGo</div>
            </div>
            <div class="search-engine-option" data-engine="google" onclick="selectSearchEngine('google', 'üîé', 'Google')">
                <div class="search-engine-option-icon">üîé</div>
                <div class="search-engine-option-name">Google</div>
            </div>
            <div class="search-engine-option" data-engine="startpage" onclick="selectSearchEngine('startpage', 'üåê', 'Startpage')">
                <div class="search-engine-option-icon">üåê</div>
                <div class="search-engine-option-name">Startpage</div>
            </div>
            <div class="search-engine-option" data-engine="brave" onclick="selectSearchEngine('brave', 'ü¶Å', 'Brave Search')">
                <div class="search-engine-option-icon">ü¶Å</div>
                <div class="search-engine-option-name">Brave Search</div>
            </div>
        </div>
    </div>
    
    <script>
        // Search engines configuration
        const searchEngines = {
            duckduckgo: { url: 'https://duckduckgo.com/?q=', icon: 'ü¶Ü', name: 'DuckDuckGo' },
            google: { url: 'https://www.google.com/search?q=', icon: 'üîé', name: 'Google' },
            startpage: { url: 'https://www.startpage.com/sp/search?query=', icon: 'üåê', name: 'Startpage' },
            brave: { url: 'https://search.brave.com/search?q=', icon: 'ü¶Å', name: 'Brave Search' }
        };
        
        // Load saved search engine (from Android or localStorage)
        function loadSearchEngine() {
            let saved = 'duckduckgo';
            // Try to get from Android first
            if (typeof Android !== 'undefined' && Android.getSearchEngine) {
                saved = Android.getSearchEngine();
            } else {
                saved = localStorage.getItem('searchEngine') || 'duckduckgo';
            }
            // Fallback to DuckDuckGo if saved engine doesn't exist (e.g., old 'qwant' preference)
            if (!searchEngines[saved]) {
                saved = 'duckduckgo';
            }
            const engine = searchEngines[saved];
            document.getElementById('searchEngineIcon').textContent = engine.icon;
            document.getElementById('searchEngineName').textContent = engine.name;
            // Update selected state in menu
            document.querySelectorAll('.search-engine-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.engine === saved) {
                    opt.classList.add('selected');
                }
            });
            return saved;
        }
        
        // Save search engine selection (to both Android and localStorage)
        function selectSearchEngine(engine, icon, name) {
            // Save to Android
            if (typeof Android !== 'undefined' && Android.setSearchEngine) {
                Android.setSearchEngine(engine);
            }
            // Also save to localStorage for web compatibility
            localStorage.setItem('searchEngine', engine);
            document.getElementById('searchEngineIcon').textContent = icon;
            document.getElementById('searchEngineName').textContent = name;
            hideSearchEngineMenu();
            // Update selected state
            document.querySelectorAll('.search-engine-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.engine === engine) {
                    opt.classList.add('selected');
                }
            });
        }
        
        // Show/hide search engine menu
        function showSearchEngineMenu() {
            document.getElementById('searchEngineMenu').classList.add('active');
        }
        
        function hideSearchEngineMenu(event) {
            if (!event || event.target.id === 'searchEngineMenu') {
                document.getElementById('searchEngineMenu').classList.remove('active');
            }
        }
        
        // Initialize search engine on load
        let currentSearchEngine = loadSearchEngine();
        
        // Search functionality
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                let query = this.value.trim();
                if (!query) return; // Don't search empty queries
                
                if (query.startsWith('http://') || query.startsWith('https://')) {
                    window.location.href = query;
                } else if (query.includes('.')) {
                    window.location.href = 'https://' + query;
                } else {
                    // Use selected search engine
                    currentSearchEngine = loadSearchEngine();
                    const engine = searchEngines[currentSearchEngine];
                    // Fallback to DuckDuckGo if engine not found (e.g., old 'qwant' preference)
                    if (engine) {
                        window.location.href = engine.url + encodeURIComponent(query);
                    } else {
                        window.location.href = searchEngines['duckduckgo'].url + encodeURIComponent(query);
                    }
                }
            }
        });
        
        // Load favorites from Android
        function loadFavorites() {
            try {
                let favorites = [];
                if (typeof Android !== 'undefined' && Android.getFavorites) {
                    const json = Android.getFavorites();
                    favorites = JSON.parse(json || '[]');
                }
                return favorites;
            } catch (e) {
                console.error('Error loading favorites:', e);
                return [];
            }
        }
        
        // Swipe handling for favorites
        let touchStartX = 0;
        let touchStartY = 0;
        let currentSwipeItem = null;
        
        function handleTouchStart(e, itemId) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            currentSwipeItem = itemId;
        }
        
        function handleTouchMove(e, itemId) {
            if (currentSwipeItem !== itemId) return;
            
            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const deltaX = touchX - touchStartX;
            const deltaY = touchY - touchStartY;
            
            // Only handle horizontal swipes
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                e.preventDefault();
                const item = document.getElementById(`favorite-${itemId}`);
                const content = item.querySelector('.favorite-item-content');
                const swipeAmount = Math.max(-80, Math.min(0, deltaX));
                content.style.transform = `translateX(${swipeAmount}px)`;
            }
        }
        
        function handleTouchEnd(e, itemId) {
            if (currentSwipeItem !== itemId) return;
            
            const touchX = e.changedTouches[0].clientX;
            const deltaX = touchX - touchStartX;
            
            const item = document.getElementById(`favorite-${itemId}`);
            
            if (deltaX < -50) {
                // Swiped left enough - show delete
                item.classList.add('swiped');
            } else {
                // Not enough swipe or swiped right - reset
                item.classList.remove('swiped');
                const content = item.querySelector('.favorite-item-content');
                content.style.transform = '';
            }
            
            currentSwipeItem = null;
        }
        
        function handleFavoriteClick(id, url) {
            const item = document.getElementById(`favorite-${id}`);
            // Only navigate if not swiped
            if (!item.classList.contains('swiped')) {
                window.location.href = url;
            } else {
                // Reset swipe on click
                item.classList.remove('swiped');
                const content = item.querySelector('.favorite-item-content');
                content.style.transform = '';
            }
        }
        
        function deleteFavorite(id, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            if (typeof Android !== 'undefined' && Android.deleteFavorite) {
                const numericId = typeof id === 'string' ? parseInt(id, 10) : id;
                const deleted = Android.deleteFavorite(numericId);
                if (deleted) {
                    const item = document.getElementById(`favorite-${id}`);
                    if (item) {
                        item.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                        item.style.transform = 'translateX(-100%)';
                        item.style.opacity = '0';
                        setTimeout(() => {
                            showFavoritesMenu();
                        }, 300);
                    } else {
                        showFavoritesMenu();
                    }
                }
            }
        }
        
        // Show favorites menu
        function showFavoritesMenu() {
            const favorites = loadFavorites();
            const container = document.getElementById('favoritesList');
            
            if (favorites.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No favorites yet. Star a page to add it here!</p>';
            } else {
                container.innerHTML = favorites.map(fav => `
                    <div class="favorite-item" id="favorite-${fav.id}">
                        <div class="favorite-item-content search-engine-option" onclick="handleFavoriteClick(${fav.id}, '${fav.url.replace(/'/g, "\\'")}')">
                            <div class="search-engine-option-icon">${fav.favicon || '‚≠ê'}</div>
                            <div class="favorite-item-info">
                                <div class="favorite-item-title">${fav.title}</div>
                                <div class="favorite-item-url">${fav.url}</div>
                            </div>
                        </div>
                        <div class="favorite-item-delete" onclick="deleteFavorite(${fav.id}, event)">Delete</div>
                    </div>
                `).join('');
                
                // Add touch event listeners
                favorites.forEach(fav => {
                    const item = document.getElementById(`favorite-${fav.id}`);
                    item.addEventListener('touchstart', (e) => handleTouchStart(e, fav.id), { passive: false });
                    item.addEventListener('touchmove', (e) => handleTouchMove(e, fav.id), { passive: false });
                    item.addEventListener('touchend', (e) => handleTouchEnd(e, fav.id), { passive: true });
                });
            }
            
            document.getElementById('favoritesMenu').classList.add('active');
        }
        
        function hideFavoritesMenu(event) {
            if (!event || event.target.id === 'favoritesMenu') {
                document.getElementById('favoritesMenu').classList.remove('active');
            }
        }
        
        // Load recent history from Android
        function loadRecentTabs() {
            try {
                let history = [];
                if (typeof Android !== 'undefined' && Android.getRecentHistory) {
                    const json = Android.getRecentHistory();
                    history = JSON.parse(json || '[]');
                }
                
                const container = document.getElementById('recentTabsList');
                
                if (history.length === 0) {
                    container.innerHTML = '<p style="color: white; text-align: center;">No recent history</p>';
                    return;
                }
                
                container.innerHTML = history.map(tab => {
                    const faviconDisplay = tab.favicon 
                        ? `<img src="${tab.favicon}" alt="" class="tab-favicon-img" onerror="this.parentElement.innerHTML='üåê';">`
                        : 'üåê';
                    // Truncate title if too long (max 40 characters)
                    const maxTitleLength = 40;
                    const displayTitle = tab.title.length > maxTitleLength 
                        ? tab.title.substring(0, maxTitleLength) + '...'
                        : tab.title;
                    // Truncate URL if too long (max 60 characters)
                    const maxUrlLength = 60;
                    const displayUrl = tab.url.length > maxUrlLength 
                        ? tab.url.substring(0, maxUrlLength) + '...'
                        : tab.url;
                    return `
                    <div class="tab-item" onclick="window.location.href='${tab.url}'">
                        <div class="tab-favicon">${faviconDisplay}</div>
                        <div class="tab-info">
                            <div class="tab-title" title="${tab.title}">${displayTitle}</div>
                            <div class="tab-url" title="${tab.url}">${displayUrl}</div>
                        </div>
                    </div>
                `;
                }).join('');
            } catch (e) {
                console.error('Error loading history:', e);
                document.getElementById('recentTabsList').innerHTML = '<p style="color: white; text-align: center;">Error loading history</p>';
            }
        }
        
        loadRecentTabs();
        
        // Refresh history when page becomes visible again (user navigates back to home)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadRecentTabs();
            }
        });
        
        // Refresh on pageshow event (handles back/forward navigation and page reload)
        window.addEventListener('pageshow', function(event) {
            loadRecentTabs();
        });
        
        // Refresh history when page gains focus (user returns to app)
        window.addEventListener('focus', function() {
            loadRecentTabs();
        });
        
        // Custom dialog functions
        function showCustomDialog(title, message, buttons) {
            document.getElementById('customDialogTitle').textContent = title;
            document.getElementById('customDialogMessage').textContent = message;
            const buttonsContainer = document.getElementById('customDialogButtons');
            buttonsContainer.innerHTML = '';
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `custom-dialog-button ${btn.class || 'secondary'}`;
                button.textContent = btn.text;
                button.onclick = () => {
                    hideCustomDialog();
                    if (btn.onclick) btn.onclick();
                };
                buttonsContainer.appendChild(button);
            });
            document.getElementById('customDialogOverlay').classList.add('active');
        }
        
        function hideCustomDialog() {
            document.getElementById('customDialogOverlay').classList.remove('active');
        }
        
        // Clear cookies and history
        function clearCookiesAndHistory() {
            showCustomDialog(
                'HNSGo',
                'HNSGo wants to clear your cookies and browsing history. This cannot be undone.',
                [
                    {
                        text: 'Cancel',
                        class: 'secondary',
                        onclick: () => {}
                    },
                    {
                        text: 'Clear',
                        class: 'primary',
                        onclick: () => {
                            if (typeof Android !== 'undefined' && Android.clearCookiesAndHistory) {
                                // Call async and wait for result
                                setTimeout(() => {
                                    const success = Android.clearCookiesAndHistory();
                                    if (success) {
                                        showCustomDialog(
                                            'HNSGo',
                                            'Cookies and history cleared successfully!',
                                            [{
                                                text: 'OK',
                                                class: 'primary',
                                                onclick: () => {
                                                    loadRecentTabs();
                                                }
                                            }]
                                        );
                                    } else {
                                        showCustomDialog(
                                            'HNSGo',
                                            'Failed to clear data. Please try again.',
                                            [{
                                                text: 'OK',
                                                class: 'primary',
                                                onclick: () => {}
                                            }]
                                        );
                                    }
                                }, 100);
                            } else {
                                showCustomDialog(
                                    'HNSGo',
                                    'Clear function not available.',
                                    [{
                                        text: 'OK',
                                        class: 'primary',
                                        onclick: () => {}
                                    }]
                                );
                            }
                        }
                    }
                ]
            );
        }
    </script>
</body>
</html>
